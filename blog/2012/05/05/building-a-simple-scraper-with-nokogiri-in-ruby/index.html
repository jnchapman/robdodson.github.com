
<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta charset="utf-8">
	<title>Building a Simple Scraper with Nokogiri in Ruby | Rob Dodson talks internets</title>

	<meta name="author" content="Rob Dodson">
	
	<meta name="description" content="Hi I'm Rob Dodson. A freelance developer specializing in JavaScript and Backbone.js with a touch of Node and Ruby.">

	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="/atom.xml" rel="alternate" title="Rob Dodson talks internets" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400" />
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>

<body class="post-template">
  <main class="content" role="main"><article class="post">
  
	<header class="post-header">
		<a id="blog-logo" href="/">Rob Dodson talks internets</a>
	</header>
	<span class="post-meta">05 May 2012</span>
	<h1 class="post-title">Building a Simple Scraper With Nokogiri in Ruby</h1>
	<section class="post-content">
		<p>Since I&#8217;ve been talking so much about <a href="http://d3js.org/">D3.js</a> lately I thought it might be fun to start a little project which combines D3 and Ruby. The idea is to build a very simple page scraper that counts how often certain words are used in each post. I&#8217;ve also decided to start adding a little block of metadata at the end of each post so I can graph that over time as well.</p>

<!--more-->


<p>So how do we get started? Well first we&#8217;ll need to build a page scraper of some kind. This program will have to consume the contents of an HTML page, find the node that contains our blog post and count up how often each word reoccurs. For right now that should be more than enough to get us started. We&#8217;ll look at grabbing the metadata and drawing graphs in future posts. I should point out that this idea was inspired by the wonderful site <a href="http://smarterware.org/5359/taking-on-the-750-words-march-challenge">750words.com</a> which creates <a href="http://smarterware.org/5359/taking-on-the-750-words-march-challenge">a beautiful exploration section</a> any time you write a new journal entry. Definitely check out that site, it&#8217;s amazing.</p>

<h3>Hello Noko</h3>

<p>I decided early on that I wanted the scraper to use <a href="http://nokogiri.org/">Nokogiri</a> because I&#8217;ve heard so much about it. As the authors describe it:</p>

<blockquote><p>Nokogiri (鋸) is an HTML, XML, SAX, and Reader parser. Among Nokogiri’s many features is the ability to search documents via XPath or CSS3 selectors.</p></blockquote>

<p>Using CSS selectors means that working with Nokogiri is a lot like working with jQuery. Here&#8217;s a quick demonstration:</p>

<figure class='code'><figcaption><span></span></figcaption><pre><code><span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;https://www.google.com/search?q=unicorns&#39;</span><span class="p">))</span>

<span class="n">doc</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;h3.r a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">link</span><span class="o">.</span><span class="n">content</span>
<span class="k">end</span>
</code></pre></figure>


<p>Easy enough, right? Taking it a step further let&#8217;s iterate over each element on the page and place them into a <code>Hash</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><pre><code><span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>

<span class="vi">@counts</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">words_from_string</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="n">string</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/[\w&#39;]+/</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">count_frequency</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">word</span> <span class="k">in</span> <span class="n">word_list</span>
    <span class="vi">@counts</span><span class="o">[</span><span class="n">word</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
  <span class="vi">@counts</span>
<span class="k">end</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;http://robdodson.me&#39;</span><span class="p">))</span>

<span class="c1">####</span>
<span class="c1"># Search for nodes by css</span>
<span class="n">entries</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;div.entry-content&#39;</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">&quot;Parsing </span><span class="si">#{</span><span class="n">entries</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="s2"> entries&quot;</span>
<span class="n">entries</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
  <span class="n">words</span> <span class="o">=</span> <span class="n">words_from_string</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
  <span class="n">count_frequency</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">sorted</span>  <span class="o">=</span> <span class="vi">@counts</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="o">|</span> <span class="n">count</span> <span class="p">}</span>
<span class="nb">puts</span> <span class="n">sorted</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</code></pre></figure>


<p>The output from this script should look (kind of) like this:</p>

<figure class='code'><figcaption><span></span></figcaption><pre><code>...
ruby: 66
rvm: 66
our: 68
can: 71
3: 75
if: 77
for: 82
your: 88
2: 88
is: 91
this: 91
s: 94
we: 95
that: 106
i: 118
in: 119
it: 125
1: 128
and: 149
of: 170
a: 231
you: 233
to: 342
the: 382
</code></pre></figure>


<p>It looks like our regex could use a bit of work so it doesn&#8217;t grab singular letters like &#8216;s&#8217; or numbers, but it&#8217;s definitely a good start. Tomorrow we&#8217;ll put everything into a <code>Module</code> and back it with tests.</p>

<p>You should follow me on Twitter <a href="http://twitter.com/rob_dodson">here.</a></p>

<ul class="personal-stats">
    <li>Mood: Relaxed, Tired</li>
    <li>Sleep: 6.5</li>
    <li>Hunger: 5</li>
    <li>Coffee: 1</li>
</ul>


	</section>


  <footer class="post-footer">
  <section class="author">
    <h4>Rob Dodson</h4>
    <p></p>
  </section>
  <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Building a Simple Scraper with Nokogiri in Ruby&amp;url=http://robdodson.me/blog/2012/05/05/building-a-simple-scraper-with-nokogiri-in-ruby/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://robdodson.me/blog/2012/05/05/building-a-simple-scraper-with-nokogiri-in-ruby/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://robdodson.me/blog/2012/05/05/building-a-simple-scraper-with-nokogiri-in-ruby/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
    </a>
  </section>
</footer>
  <hr>
  
    <div class="share">
</div>

  
  
  <section id="comment">
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>
  
</article></main>
  <footer class="site-footer"><a class="subscribe icon-feed" href="http://robdodson.me/atom.xml"><span class="tooltip">Subscribe!</span></a>
<div class="inner">
  Follow me on <a href="http://twitter.com/rob_dodson" rel="me">Twitter</a>, <a rel="author" href="https://plus.google.com/118271135596408598424">Google+</a> or <a rel="me" href="http://github.com/robdodson">Github</a>
  <section class="copyright">All content copyright <a href="/">Rob Dodson</a> © 2013 • All rights reserved.</section>
  <section class="poweredby">Casper theme by <a class="icon-ghost" href="http://tryghost.org">Ghost</a> &amp; Published with <a href="http://octopress.org">Octopress</a></section>
</div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>  
<script>hljs.initHighlightingOnLoad()</script>


<script type="text/javascript">
      var disqus_shortname = 'robdodsontalksinternets';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://robdodson.me/blog/2012/05/05/building-a-simple-scraper-with-nokogiri-in-ruby/';
        var disqus_url = 'http://robdodson.me/blog/2012/05/05/building-a-simple-scraper-with-nokogiri-in-ruby/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-25869920-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</body>
</html>
